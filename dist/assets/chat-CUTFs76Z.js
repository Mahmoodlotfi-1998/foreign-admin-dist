import{b as g,k as C,G as E,aE as i,d as M,j as B,o as v,aa as m,a as l,p as _,w as S,F as z,ab as T,u as w,ac as y,a6 as $,n as A,aC as D,aq as L,aD as U,ao as b}from"./index-C59nPxhS.js";import{_ as F}from"./BasicTextArea.vue_vue_type_style_index_0_lang-DaM2e8TG.js";function N(t){const e=g([]),r=g(!0),u=async()=>{const{data:a,error:s}=await i.from("chat").select("chat_log").eq("id",t).single();if(s){console.error("Error fetching chat log:",s);return}e.value=(a==null?void 0:a.chat_log)||[],r.value=!1},h=async a=>{e.value.push(a);const{error:s}=await i.from("chat").update({chat_log:e.value}).eq("id",t);s&&console.error("Error updating chat log:",s)},d=async(a,s)=>{if(!e.value[a])return;e.value[a].status=s;const{error:o}=await i.from("chat").update({chat_log:e.value}).eq("id",t);o&&console.error("Error updating message status:",o)},f=()=>{console.log("salammm"),e.value.forEach((a,s)=>{a.status==="delivered"&&a.sender!=="me"&&d(s,"read")})},p=()=>{i.channel(`realtime:chat:${t}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"chat",filter:`id=eq.${t}`},a=>{e.value=a.new.chat_log||[],e.value.forEach((s,o)=>{s.status==="sent"&&s.sender!=="borrower"&&d(o,"delivered")})}).subscribe()},n=()=>{i.removeChannel(`realtime:chat:${t}`)};return C(()=>{u(),p()}),E(()=>{n()}),{chatLog:e,appendMessage:h,markMessagesAsRead:f,loading:r}}const R={class:"h65vh"},V={class:"chat-display"},j={class:"absolute bottom-0 right-0 left-0 bg-white z-20"},G={class:"flex items-center p-3 w-full gap-3"},H=M({__name:"Chat",props:{id:{}},setup(t){const e=g(null),r=t;console.log("ss",r.id);const{chatLog:u,loading:h,markMessagesAsRead:d,appendMessage:f}=N(r.id);C(()=>{d()});const p=async()=>{await A(),e.value&&(e.value.scrollTop=e.value.scrollHeight)},n=g("");B(u,()=>{p()});const a=()=>{if(!n.value.trim())return;const s={sender:"admin",message:n.value,status:"sent",timestamp:new Date().toISOString()};f(s),n.value="",p()};return(s,o)=>{const x=D,q=L;return v(),m("div",R,[l("div",null,[l("div",V,[_(x,{spinning:w(h)},{default:S(()=>[l("div",{class:"h-65vh pb-20 overflow-y-auto",ref_key:"chatContainer",ref:e},[(v(!0),m(z,null,T(w(u),(c,k)=>(v(),m("div",{key:k,class:"flex relative flex-col mt-1"},[l("div",{class:y(c.sender==="me"?"bg-gray-300 w-fit px-2 py-1 rounded-xl z-10":"bg-green self-end w-fit px-2 py-1 rounded-xl text-white z-10")},$(c.message),3),l("div",{class:y(c.sender==="me"?" bg-gray-300 absolute bottom-0 left-0 h-2 w-2":"bg-green absolute bottom-0 right-0 h-2 w-2")},null,2)]))),128))],512)]),_:1},8,["spinning"])])]),l("div",j,[l("div",G,[_(F,{class:"!h-full w-full","place-holder":"",value:n.value,"onUpdate:value":o[0]||(o[0]=c=>n.value=c),rows:2},null,8,["value"]),_(q,{shape:"circle",type:"primary",class:"aspect-square",size:"large",icon:"vuesax-linear:send-1",onClick:a,disabled:n.value===""},null,8,["disabled"])])])])}}}),J=U(H,[["__scopeId","data-v-956766db"]]),K=async t=>await b.fetch("chat","select",{column:"id",field:"request_id",value:t}),Q=async t=>b.fetch("pricing_requests","update",{data:{call_request:!1},field:"id",value:t}),W=async t=>await b.fetch("pricing_requests","update",{field:"id",value:t,data:{new_message:!1}});export{J as C,Q as c,K as g,W as s};
